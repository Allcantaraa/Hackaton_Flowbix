{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px; font-family: sans-serif;">

    {% if messages %}
        {% for message in messages %}
            <div style="padding: 15px; margin-bottom: 20px; border-radius: 4px; {% if message.tags == 'error' %} background: #f8d7da; color: #721c24; {% else %} background: #d4edda; color: #155724; {% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <header style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 20px;">
        <div>
            <h1 style="margin: 0;">{{ sala.nome }}</h1>
            <p style="color: #666;">{{ sala.descricao }}</p>
        </div>
        <div style="text-align: right;">
            <strong style="display: block; color: #3498db; text-transform: uppercase; margin-bottom: 10px;">{{ sala.get_status_display }}</strong>
            
            {% if user.perfil.eh_jurado %}
                {% if avaliacoes_concluidas %}
                    <span style="background: #a0aec0; color: white; padding: 10px 18px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; cursor: not-allowed;">ğŸ”’ Notas Encerradas</span>
                {% else %}
                    <a href="{% url 'painel_jurado' sala.id %}" style="background: #6b46c1; color: white; padding: 10px 18px; text-decoration: none; border-radius: 5px; font-weight: bold;">ğŸ‘¨â€âš–ï¸ Avaliar Projetos</a>
                {% endif %}
            {% endif %}
        </div>
    </header>

    {% if user.is_staff %}
    <section style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin-top: 0;">âš™ï¸ Admin</h4>
        {% if sala.status == 'aberta' %}
            <a href="{% url 'realizar_sorteio' sala.id %}" style="background: #e67e22; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px;">Sorteio Geral</a>
        {% elif sala.status == 'sorteio' %}
            <form method="POST" action="{% url 'iniciar_sala' sala.id %}" style="display: inline-flex; gap: 10px;">
                {% csrf_token %}
                <input type="number" name="duracao_horas" value="60" style="width: 60px;"> Minutos
                <button type="submit" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ğŸš€ Iniciar</button>
            </form>
        {% endif %}
    </section>
    {% endif %}

    {% if not user.perfil.eh_jurado and request.user not in sala.participantes.all and sala.status == 'aberta' %}
    <div style="text-align: center; padding: 30px; background: #f0f7ff; border: 2px dashed #3498db; border-radius: 10px; margin-bottom: 30px;">
        <h3>Deseja competir?</h3>
        <a href="{% url 'inscrever_sala' sala.id %}" style="background: #3498db; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">Participar como Competidor</a>
    </div>
    {% endif %}

    {% if sala.status == 'andamento' %}
        <div style="background: #2c3e50; color: #2ecc71; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 30px;">
            <div id="contagem" style="font-size: 3rem; font-family: monospace; font-weight: bold;">--:--:--</div>
        </div>
    {% elif sala.status == 'finalizada' %}
        <div style="background: #fefcbf; padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 30px; border: 2px solid #faf089;">
            <h2 style="margin-top: 0;">ğŸ Hackaton Encerrado!</h2>
            <a href="{% url 'ranking_sala' sala.id %}" style="background: #2d3748; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: bold;">ğŸ† VER RANKING FINAL</a>
        </div>
    {% endif %}

    {% if sala.status != 'aberta' %}
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px; background: white; border: 1px solid #eee;">
        <thead>
            <tr style="background: #f8f9fa; text-align: left;">
                <th style="padding: 12px;">Equipe</th>
                <th style="padding: 12px;">Integrantes</th>
                <th style="padding: 12px;">Tema</th>
                <th style="padding: 12px; text-align: center;">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for gp in todos_os_grupos %}
            <tr style="border-bottom: 1px solid #eee; {% if gp == meu_grupo %} background: #f0f7ff; {% endif %}">
                <td style="padding: 12px;"><strong>{{ gp.nome }}</strong></td>
                <td style="padding: 12px; font-size: 0.85rem;">â­ <b>{{ gp.lider.username }}</b>, {{ gp.membros.all|join:", " }}</td>
                <td style="padding: 12px;">{{ gp.tema.titulo|default:"-" }}</td>
                <td style="padding: 12px; text-align: center;">{% if gp.entrega %}âœ…{% else %}â³{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px;">
        <div style="background: white; border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
            <h3>ğŸš€ Entrega</h3>
            {% if sala.status == 'andamento' %}
                {% if entrega %}
                    <p style="color: green;">âœ“ Seu grupo jÃ¡ realizou a entrega.</p>
                {% elif liderando %}
                    <form method="POST">
                        {% csrf_token %}
                        <input type="url" name="link_projeto" placeholder="Link do Projeto" required style="width: 100%; padding: 10px; margin-bottom: 10px;">
                        <textarea name="comentarios" placeholder="Notas tÃ©cnicas..." style="width: 100%; padding: 10px; margin-bottom: 10px;"></textarea>
                        <button type="submit" name="btn_entrega" style="width: 100%; background: #3182ce; color: white; padding: 12px; border: none; border-radius: 5px; cursor: pointer;">SUBMETER</button>
                    </form>
                {% else %}
                    <p>Aguardando o lÃ­der <b>{{ meu_grupo.lider.username }}</b>.</p>
                {% endif %}
            {% else %}
                <p style="color: #999;">O portal estÃ¡ fechado.</p>
            {% endif %}
        </div>

        <div style="background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; height: 400px; display: flex; flex-direction: column;">
            <h3>ğŸ’¬ Chat</h3>
            <div id="chat-box" style="flex-grow: 1; overflow-y: auto; background: #f9f9f9; padding: 10px; border: 1px solid #eee; margin-bottom: 10px;"></div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="msg-texto" placeholder="Texto..." style="flex-grow: 1; padding: 8px;">
                <button id="btn-enviar" style="background: #2d3748; color: white; border: none; padding: 8px; cursor: pointer;">Enviar</button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // CRONÃ”METRO
    {% if sala.status == 'andamento' and sala.inicio_atividades %}
    function atualizarCronometro() {
        const dataInicio = new Date("{{ sala.inicio_atividades.isoformat }}").getTime();
        const tempoLimite = dataInicio + ({{ sala.duracao_horas }} * 60 * 1000);
        const agora = new Date().getTime();
        const faltam = tempoLimite - agora;

        if (faltam <= 0) { location.reload(); return; }

        const h = Math.floor(faltam / 3600000);
        const m = Math.floor((faltam % 3600000) / 60000);
        const s = Math.floor((faltam % 60000) / 1000);
        document.getElementById('contagem').innerHTML = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    setInterval(atualizarCronometro, 1000);
    atualizarCronometro();
    {% endif %}

    // CHAT (SÃ­ncrono com seu backend)
    function buscarMensagens() {
        fetch(`/chat/mensagens/{{ sala.id }}/`).then(res => res.json()).then(data => {
            const chat = document.getElementById('chat-box');
            chat.innerHTML = '';
            data.mensagens.forEach(msg => {
                chat.innerHTML += `<div><small><b>${msg.usuario}</b></small><p style="margin:0 0 8px 0;">${msg.texto}</p></div>`;
            });
            chat.scrollTop = chat.scrollHeight;
        });
    }
    setInterval(buscarMensagens, 4000);
    buscarMensagens();

    document.getElementById('btn-enviar').onclick = function() {
        const texto = document.getElementById('msg-texto').value;
        const formData = new FormData();
        formData.append('texto', texto);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        fetch(`/chat/enviar/{{ sala.id }}/`, { method: 'POST', body: formData }).then(() => {
            document.getElementById('msg-texto').value = '';
            buscarMensagens();
        });
    };
</script>
{% endblock %}