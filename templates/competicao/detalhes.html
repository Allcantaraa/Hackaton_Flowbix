<hr>

{% if request.user in sala.participantes.all %}

    <h3>Chat da sala: {{ sala.nome }}</h3>

    <div id="chat-box" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f9f9f9;">
    </div>

    <div id="chat-form">
        {% csrf_token %}
        <input type="text" id="msg-texto" placeholder="Digite sua mensagem..." style="width: 80%;">
        <button id="btn-enviar">Enviar</button>
    </div>

    <hr>

    <div id="entrega-container" style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
        <h3>ğŸš€ Entrega da SoluÃ§Ã£o</h3>

        {% if entrega %}
            <div style="background-color: #d4edda; color: #155724; padding: 15px; border-radius: 5px;">
                <p>âœ… <strong>Projeto entregue pelo grupo: {{ entrega.grupo.nome }}</strong></p>
                <p>Link: <a href="{{ entrega.link_projeto }}" target="_blank" style="color: #155724; font-weight: bold;">{{ entrega.link_projeto }}</a></p>
                <small>Enviado em: {{ entrega.data_entrega|date:"d/m H:i" }}</small>
            </div>
        {% elif liderando %}
            <form method="POST">
                {% csrf_token %}
                <p>VocÃª Ã© o <strong>CabeÃ§a de Chave</strong> do grupo: <strong>{{ liderando.nome }}</strong></p>
                
                <div style="margin-bottom: 10px;">
                    <label>Link da SoluÃ§Ã£o (Zabbix, Grafana, GitHub, etc):</label><br>
                    <input type="url" name="link_projeto" placeholder="https://..." required style="width: 100%; padding: 8px;">
                </div>

                <div style="margin-bottom: 10px;">
                    <label>ComentÃ¡rios Adicionais:</label><br>
                    <textarea name="comentarios" rows="3" style="width: 100%; padding: 8px;" placeholder="Explique brevemente sua soluÃ§Ã£o..."></textarea>
                </div>

                <button type="submit" name="btn_entrega" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    Realizar Entrega Oficial
                </button>
            </form>
        {% else %}
            <div style="background-color: #fff3cd; color: #856404; padding: 15px; border-radius: 5px;">
                <p>Aguardando a entrega da soluÃ§Ã£o pelo seu <strong>CabeÃ§a de Chave</strong>.</p>
            </div>
        {% endif %}
    </div>

{% else %}
    <div style="text-align: center; padding: 20px; border: 2px dashed #ccc;">
        <h3>VocÃª ainda nÃ£o estÃ¡ participando desta competiÃ§Ã£o.</h3>
        <p>Para enviar mensagens e ver os desafios, vocÃª precisa se inscrever.</p>
        <a href="{% url 'inscrever_sala' sala.id %}" 
           style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
           Participar da Sala
        </a>
    </div>
{% endif %}

<script>
    const salaId = "{{ sala.id }}";
    const chatBox = document.getElementById('chat-box');
    const btnEnviar = document.getElementById('btn-enviar');
    const inputTexto = document.getElementById('msg-texto');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function buscarMensagens() {
        fetch(`/chat/mensagens/${salaId}/`)
            .then(response => response.json())
            .then(data => {
                chatBox.innerHTML = '';
                data.mensagens.forEach(msg => {
                    const div = document.createElement('div');
                    div.style.marginBottom = "5px";
                    div.innerHTML = `<strong>${msg.usuario}</strong> [${msg.data}]: ${msg.texto}`;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
    }

    btnEnviar.onclick = function() {
        const texto = inputTexto.value;
        if (!texto) return;

        const formData = new FormData();
        formData.append('texto', texto);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`/chat/enviar/${salaId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                inputTexto.value = '';
                buscarMensagens();
            }
        });
    };

    setInterval(buscarMensagens, 3000);
    buscarMensagens();
</script>